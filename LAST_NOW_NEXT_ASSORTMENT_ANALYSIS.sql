-- cte1: identifies the most recent active assortment sku locations
WITH cte1 AS (SELECT DISTINCT mx.SKULOC
			, MAX(mx."ASSORTMENT RANK") OVER (PARTITION BY mx."LOCATION", mx.SKU) AS "MAX_RANK"
			FROM MERCH_ANALYSIS.SIGMA.VIEW_ASSORTMENT_LOCATION_SKU_9MONTH_ROLLING_DE8F3B69BEF64BEEA6324BA484061C4F_MAT AS mx
			WHERE mx."VALIDITY PERIOD ACTIVE FLAG" = 1)
			
-- cte2: filters Base Table to records identified by cte1			
	,cte2 AS (SELECT nw.*
			FROM MERCH_ANALYSIS.SIGMA.VIEW_ASSORTMENT_LOCATION_SKU_9MONTH_ROLLING_DE8F3B69BEF64BEEA6324BA484061C4F_MAT AS nw
			INNER JOIN cte1
				ON cte1.SKULOC = nw.SKULOC AND cte1.MAX_RANK = nw."ASSORTMENT RANK"
--			WHERE nw.SKU IN (1001700001, 1005240001, 1438790005, 1499130001, 1526250001, 1560970001, 1560970002, 1560970003, 1560970004, 1663940001, 1663960001, 1663970001, 1670890008, 1676850001, 1707880001, 1707880002, 1707880003, 1707880004, 1733650001, 1772690033, 1774920001, 1774920002, 1774920003, 1774920004, 1774920005, 1774920006, 1774980001, 1774980002, 1774980003, 1774980004, 1774980005, 1774980006, 1829890001, 1829890002, 1829890003, 1845040001, 1916920003, 2025180014, 2027740001, 2039060004, 2067110002, 2119940001, 2119940002, 2119940003, 7517210014)
			)

-- cte3: filters Base Table to records with last assortment	per sku location		
	,cte3 AS (SELECT nw.*
			FROM MERCH_ANALYSIS.SIGMA.VIEW_ASSORTMENT_LOCATION_SKU_9MONTH_ROLLING_DE8F3B69BEF64BEEA6324BA484061C4F_MAT AS nw
			LEFT JOIN cte1
				ON cte1.SKULOC = nw.SKULOC AND cte1.MAX_RANK > nw."ASSORTMENT RANK"
--			WHERE nw.SKU IN (1001700001, 1005240001, 1438790005, 1499130001, 1526250001, 1560970001, 1560970002, 1560970003, 1560970004, 1663940001, 1663960001, 1663970001, 1670890008, 1676850001, 1707880001, 1707880002, 1707880003, 1707880004, 1733650001, 1772690033, 1774920001, 1774920002, 1774920003, 1774920004, 1774920005, 1774920006, 1774980001, 1774980002, 1774980003, 1774980004, 1774980005, 1774980006, 1829890001, 1829890002, 1829890003, 1845040001, 1916920003, 2025180014, 2027740001, 2039060004, 2067110002, 2119940001, 2119940002, 2119940003, 7517210014)
			)

-- cte4: filters Base Table to records with next assortment per sku location		
	,cte4 AS (SELECT nw.*
			FROM MERCH_ANALYSIS.SIGMA.VIEW_ASSORTMENT_LOCATION_SKU_9MONTH_ROLLING_DE8F3B69BEF64BEEA6324BA484061C4F_MAT AS nw
			LEFT JOIN cte1
				ON cte1.SKULOC = nw.SKULOC AND cte1.MAX_RANK < nw."ASSORTMENT RANK" 
--			WHERE nw.SKU IN (1001700001, 1005240001, 1438790005, 1499130001, 1526250001, 1560970001, 1560970002, 1560970003, 1560970004, 1663940001, 1663960001, 1663970001, 1670890008, 1676850001, 1707880001, 1707880002, 1707880003, 1707880004, 1733650001, 1772690033, 1774920001, 1774920002, 1774920003, 1774920004, 1774920005, 1774920006, 1774980001, 1774980002, 1774980003, 1774980004, 1774980005, 1774980006, 1829890001, 1829890002, 1829890003, 1845040001, 1916920003, 2025180014, 2027740001, 2039060004, 2067110002, 2119940001, 2119940002, 2119940003, 7517210014)
			)		

-- cte5: combines cte2 and cte3 to make the comparison of NOW to LAST
--	,cte5 AS (SELECT cte2.SKU
--			, cte2."LOCATION"
--			, cte3."ASSORTMENT ID" AS LAST_ASSORTMENT
--			, cte2."ASSORTMENT ID" AS ACTIVE_ASSORTMENT
--			FROM cte2
--			FULL OUTER JOIN cte3
--			ON cte2."SKU KEY" = cte3."SKU KEY" AND cte2."LOCATION KEY" = cte3."LOCATION KEY"
--			)
--
-- cte5: combines cte2 and cte3 to make the comparison of NOW to NEXT
--	,cte6 AS (SELECT cte2.SKU
--			, cte2."LOCATION"
--			, cte2."ASSORTMENT ID" AS ACTIVE_ASSORTMENT
--			, cte4."ASSORTMENT ID" AS NEXT_ASSORTMENT
--			FROM cte2
--			FULL OUTER JOIN cte4
--			ON cte2."SKU KEY" = cte4."SKU KEY" AND cte2."LOCATION KEY" = cte4."LOCATION KEY"
--			)

			
--SELECT * FROM cte1
--
--SELECT * FROM cte2
--
--SELECT * FROM cte3
--
--SELECT * FROM cte4
--
--SELECT * FROM cte5 WHERE ACTIVE_ASSORTMENT IS NULL
--
--SELECT * FROM cte6 WHERE ACTIVE_ASSORTMENT IS NULL
		
			







-- Three part query: join cte2, 3, and 4 together to create view that provides visibility into assortment location sku transitions.
SELECT cte3.SKU AS LAST_SKU
	, cte3."LOCATION" AS LAST_LOCATION
	, cte3."ASSORTMENT ID" AS LAST_ASSORTMENT
	, cte2.SKU AS ACTIVE_SKU
	, cte2."LOCATION" AS ACTIVE_LOCATION
	, cte2."ASSORTMENT ID" AS ACTIVE_ASSORTMENT
	, cte4.SKU AS NEXT_SKU
	, cte4."LOCATION" AS NEXT_LOCATION
	, cte4."ASSORTMENT ID" AS NEXT_ASSORTMENT
FROM cte2
FULL OUTER JOIN cte3
	ON cte2."SKU KEY" = cte3."SKU KEY" AND cte2."LOCATION KEY" = cte3."LOCATION KEY"
FULL OUTER JOIN cte4
	ON cte2."SKU KEY" = cte4."SKU KEY" AND cte2."LOCATION KEY" = cte4."LOCATION KEY"

WHERE LAST_ASSORTMENT IS NOT NULL
	AND ACTIVE_ASSORTMENT IS NOT NULL
	AND NEXT_ASSORTMENT IS NOT NULL
	
ORDER BY cte2.SKU, cte2."LOCATION"	
;






















