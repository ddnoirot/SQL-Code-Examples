SELECT 
		ast.ASSORTMENT_KEY 
		, ast.ASSORTMENT_ID 
		, ast.ASSORTMENT_DESC 
		, ast.SALES_ORGANIZATION_KEY 
		, ast.SALES_ORGANIZATION_CODE 
		, ast.DISTRIBUTION_CHANNEL_KEY
		, ast.DISTRIBUTION_CHANNEL_CODE
		, ast.ASSORTMENT_CATEGORY_CODE 
		, ast.ASSORTMENT_CATEGORY_DESC
		, alo.SAP_DIVISION_KEY 
		, alo.SAP_DIVISION_ID 
		, alo.LOCATION_KEY 
		, alo."LOCATION"
		, ask.SKU_KEY 
		, ask.SKU
		, ask.PRODUCT_KEY 
		, ask.PRODUCT
		, ast.ASSORTMENT_VALID_FROM_DATE 
		, ast.ASSORTMENT_VALID_TO_DATE
		, alo.ASSORTMENT_LOCATION_VALID_FROM_DATE 
		, alo.ASSORTMENT_LOCATION_VALID_TO_DATE  
		, ask.ASSORTMENT_SKU_VALID_FROM_DATE 
		, ask.ASSORTMENT_SKU_VALID_TO_DATE
		, CONCAT(ask.SKU, alo."LOCATION") AS SKULOC
		, ROW_NUMBER () OVER(
			PARTITION BY SKULOC
			ORDER BY ask.ASSORTMENT_SKU_VALID_TO_DATE 
			) AS ASSORTMENT_RANK
		, (CASE
			WHEN ask.ASSORTMENT_SKU_VALID_TO_DATE < CURRENT_DATE() THEN 0
			WHEN ask.ASSORTMENT_SKU_VALID_FROM_DATE > CURRENT_DATE() THEN 0
			ELSE 1
			END
			) AS VALIDITY_PERIOD_ACTIVE_FLAG
		
		
	FROM MERCHANDISING.MERCHANDISING.ASSORTMENT ast
	
	RIGHT JOIN MERCHANDISING.MERCHANDISING.ASSORTMENT_LOCATION alo
		ON ast.ASSORTMENT_KEY = alo.ASSORTMENT_KEY 
		
	RIGHT JOIN MERCHANDISING.MERCHANDISING.ASSORTMENT_SKU ask
		ON alo.ASSORTMENT_KEY = ask.ASSORTMENT_KEY 

	--FILTER TO records WITH validity period greater than 14 DAYS. Anything shorter than 14 days can be thought OF AS a TEMPORARY assortment not relevant to the business case.
	--FILTER to records with validity period less than 400 days. Anything longer than 400 days can be considered not seasonal.
	--FILTER TO SKU records WITH valid TO dates BEFORE '9999-12-31'. 
	--FILTER TO LOCATION records WITH valid TO date AFTER today's date. Removes any closed or non active locations.
	--FILTER to seasonal assortment id's beggining WITH 'F' or 'S' or 'Y'
	--FILTER to SKU records with validity that ended greater than 182 days before today.
	--FILTER to SKU records with validity that starts less than 91 days after today.
	--FILTER to SKU records with Event Type > 0. Removes duplicate ASSORTMENT SKU's that show in season ASSORTMENT SKU changes. To be utilized later.  	
	WHERE 
		ask.ASSORTMENT_SKU_VALID_TO_DATE - ask.ASSORTMENT_SKU_VALID_FROM_DATE > 14
		AND ask.ASSORTMENT_SKU_VALID_TO_DATE - ask.ASSORTMENT_SKU_VALID_FROM_DATE < 400
		AND ask.ASSORTMENT_SKU_VALID_TO_DATE < '9999-12-31'
		AND alo.ASSORTMENT_LOCATION_VALID_TO_DATE > CURRENT_DATE()
		AND (ast.ASSORTMENT_ID LIKE 'F%' OR ast.ASSORTMENT_ID LIKE 'S%' OR ast.ASSORTMENT_ID LIKE 'Y%') -- ???ARE THESE VALID LIMITERS???
		AND ask.ASSORTMENT_SKU_VALID_TO_DATE > (CURRENT_DATE() - 182)
		AND ask.ASSORTMENT_SKU_VALID_FROM_DATE < (CURRENT_DATE() + 91)
--		AND ask.SKU IN (1001700001, 1005240001, 1438790005, 1499130001, 1526250001, 1560970001, 1560970002, 1560970003, 1560970004, 1663940001, 1663960001, 1663970001, 1670890008, 1676850001, 1707880001, 1707880002, 1707880003, 1707880004, 1733650001, 1772690033, 1774920001, 1774920002, 1774920003, 1774920004, 1774920005, 1774920006, 1774980001, 1774980002, 1774980003, 1774980004, 1774980005, 1774980006, 1829890001, 1829890002, 1829890003, 1845040001, 1916920003, 2025180014, 2027740001, 2039060004, 2067110002, 2119940001, 2119940002, 2119940003, 7517210014 
--						)
		AND ask.M_EVENT_TYPE_ID > 0
		
	ORDER BY
		ask.SKU ASC
		, alo."LOCATION" ASC
		, ask.ASSORTMENT_SKU_VALID_TO_DATE DESC
		, ast.ASSORTMENT_VALID_FROM_DATE DESC
		
--LIMIT 5000
;